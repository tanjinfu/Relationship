<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link rel="stylesheet" href="./Scripts/zTree_v3/css/zTreeStyle/zTreeStyle.css" />
    <script type="text/javascript" src="./Scripts/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="./Scripts/zTree_v3/js/jquery.ztree.core-3.5.js"></script>
    <script type="text/javascript" src="./Scripts/knockout-3.2.0.debug.js"></script>
    <script type="text/javascript" src="./Scripts/relationship.js"></script>
    <script language="JavaScript">

    </script>
</head>
<body>
    <div>
        <p data-bind="visible: errorMessage">Error: <span data-bind="text: errorMessage"></span></p>
    </div>
    <table style="vertical-align:top;align-self:center;width:1000px;border:1px">
        <tr>
            <td style="width:40%;height:600px;">
                <ul id="treeDemo" class="ztree"></ul>
            </td>
            <td style="width:1%;background-color:gray"></td>
            <td style="width:100%">
                <table style="width:100%">
                    <tr>
                        <td>姓</td>
                        <td data-bind="text: lastName()"></td>
                        <td>名</td>
                        <td data-bind="text: firstName()"></td>
                        <td>性别</td>
                        <td data-bind="text: formattedGender()"></td>
                        <td>排行</td>
                        <td data-bind="text: orderInChildrenOfParents()"></td>
                    </tr>
                    <tr>
                        <td>出生日期</td>
                        <td data-bind="text: formattedBirthDay()"></td>
                        <td>时间</td>
                        <td data-bind="text: birthTime()"></td>
                        <td>逝世日期</td>
                        <td data-bind="text: formattedDeathDay()"></td>
                        <td>时间</td>
                        <td data-bind="text: deathTime()"></td>
                    </tr>
                    <tr>
                        <td>父亲</td>
                        <td><span data-bind="text:fatherLastName()"></span><span data-bind="text:fatherFirstName()"></span></td>
                        <td>母亲</td>
                        <td><span data-bind="text:motherLastName()"></span><span data-bind="text:motherFirstName()"></span></td>
                        <td></td>
                        <td data-bind="text: formattedDeathDay()"></td>
                        <td></td>
                        <td data-bind="text: deathTime()"></td>
                    </tr>
                    <tr>
                        <td>子女</td>
                        <td colspan="7">
                            <span data-bind="foreach: childrenByFather">
                                <span data-bind="text: LastName"></span><span data-bind="text: FirstName"></span>,
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>备注</td>
                        <td colspan="7" data-bind="text: remark()"></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <script>
        var genders = [
    { value: '1', description: '男' },
    { value: '0', description: '女' },
        ];
        var defaultPerson = {
            birthDay: '',
            birthTime: '',
            deathDay: '',
            deathTime: '',
            fatherId: 0,
            id: 0,
            firstName: '',
            lastName: '',
            remark: '',
            motherId: 0,
            gender: 1,
            order: 1
        };

        var viewModel = {
            // person info
            id: ko.observable(defaultPerson.id),
            birthDay: ko.observable(defaultPerson.birthDay),
            birthTime: ko.observable(defaultPerson.birthTime),
            childrenByFather: ko.observableArray(),
            deathDay: ko.observable(defaultPerson.deathDay),
            deathTime: ko.observable(defaultPerson.deathTime),
            fatherFirstName: ko.observable(),
            fatherId: ko.observable(defaultPerson.fatherId),
            fatherLastName: ko.observable(),
            firstName: ko.observable(defaultPerson.firstName),
            gender: ko.observable(defaultPerson.gender),
            lastName: ko.observable(defaultPerson.lastName),
            motherFirstName: ko.observable(),
            motherId: ko.observable(defaultPerson.motherId),
            motherLastName: ko.observable(),
            orderInChildrenOfParents: ko.observable(defaultPerson.orderInChildrenOfParents),
            remark: ko.observable(defaultPerson.remark),
            //
            errorMessage: ko.observable(),
        };
        viewModel.formattedGender = ko.dependentObservable(function () {
            return this.gender() == 1 ? "男" : "女";
        }, viewModel);
        viewModel.formattedBirthDay = ko.dependentObservable(function () {
            return this.birthDay().indexOf("1:") >= 0 ? this.birthDay().replace("1:", "") : this.birthDay().replace("0:", "公元前 ");
        }, viewModel);
        viewModel.formattedDeathDay = ko.dependentObservable(function () {
            return this.deathDay().indexOf("1:") >= 0 ? this.deathDay().replace("1:", "") : this.deathDay().replace("0:", "公元前 ");
        }, viewModel);
        ko.applyBindings(viewModel); // Makes Knockout get to work

        function updateViewModelOfPerson(result) {
            viewModel.id(result.Id);
            viewModel.birthDay(result.BirthDay);
            viewModel.birthTime(result.BirthTime);
            viewModel.deathDay(result.DeathDay);
            viewModel.deathTime(result.DeathTime);
            if (result.Father != null) {
                viewModel.fatherFirstName(result.Father.FirstName);
                viewModel.fatherLastName(result.Father.LastName);
            }
            viewModel.fatherId(result.FatherId);
            if (result.Mother != null) {
                viewModel.motherFirstName(result.Mother.FirstName);
                viewModel.motherLastName(result.Mother.LastName);
            }
            viewModel.motherId(result.MotherId),
            viewModel.gender(result.Gender),
            viewModel.orderInChildrenOfParents(result.OrderInChildrenOfParents),
            viewModel.remark(result.Remark),
            viewModel.firstName(result.FirstName);
            viewModel.lastName(result.LastName);
            viewModel.childrenByFather(result.ChildrenByFather)
        }

        function zTreeOnClick(event, treeId, treeNode) {
            viewModel.errorMessage(null); // clear error message
            $.get("odata/People(" + treeNode.Id + ")?$expand=Mother($select=Id,FirstName,LastName),Father($select=Id,FirstName,LastName),ChildrenByFather($select=Id,FirstName,LastName)", null, updateViewModelOfPerson, "json");
        };

        var setting = {
            async: {
                enable: true,
                url: getAsyncUrl,
                autoParam: ["id", "name=n", "level=lv"],
                type: "get",
                dataFilter: filter
            },
            callback: {
                onClick: zTreeOnClick
            }
        };

        function filter(treeId, parentNode, responseData) {
            if (!responseData) return null;
            for (var i = 0, l = responseData.value.length; i < l; i++) {
                responseData.value[i].name = responseData.value[i].LastName + responseData.value[i].FirstName;
                if (responseData.value[i].Gender == 1) {
                    responseData.value[i].isParent = true;
                }
            }
            return responseData.value;
        }

        function getAsyncUrl(treeId, treeNode) {
            var url = treeNode == undefined ? "/odata/GetRootPersons()" : "/odata/People(" + treeNode.Id + ")/ChildrenByFather";
            return url;
        };

        $(document).ready(function () {
            $.fn.zTree.init($("#treeDemo"), setting);
        });
    </script>
</body>
</html>
